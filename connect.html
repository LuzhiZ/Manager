<!DOCTYPE html>
<html>
<head>
	<title>ConnecttoServer</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./css/style.css">

    <script type="text/javascript" src="./js/exchange.js"></script>
    <script type="text/javascript" src="./js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="./js/jquery-ui.min.js"></script>
    <script src="http://demo.qunee.com/lib/qunee-min.js"></script>
    <script src="./js/data_struct.js"></script>
    <script type="text/javascript" src="./js/message.js"></script>
	<script src="./js/data_source.js"></script>
</head>
<body>
<div class="top-menu">
	<div class="title">MANAGER</div>
</div>
<div class="mainbody">
	<div class="left-menu">
	</div>
	<div class="left-btn"><span></span>
	</div>
	<div  class="right-show" id="canvas"/>
		<canvas id="main-graph" width="1118" height="596"></canvas>
		<!-- <div class="retangle" style="position: absolute;left:4px;top:4px;width:208px;height:208px;display: block;z-index: 1;cursor: move;">
			<div class="shape-box" style="position: absolute;left:4px;top:4px;width:198px;height:198px;background-color:white;z-index: 0;display:block; border:solid 1px black;">
				<canvas class="shape-canvas" width="200" height="200"></canvas>
			</div>
			<div id="shape-control" style="position: absolute;left:4px;top:4px;width:198px;height:198px;display: none;z-index: 1; border:solid 1px #63da7e;">
				<canvas id="control-bounding" width="208" height="208"></canvas>
				<div id="nw" class="shape-controler " style="background:white; position: absolute;left: -5px;top: -5px; width: 8px;height: 8px; border:solid 1px #63da7e;z-index:2;cursor: nw-resize;"></div>
				<div id="ne" class="shape-controler " style="background:white; position: absolute;right:-5px;top: -5px; width: 8px;height: 8px; border:solid 1px #63da7e;z-index: 2;cursor: ne-resize;"></div>
				<div id="sw" class="shape-controler " style="background:white; position: absolute;left: -5px;bottom: -5px; width: 8px;height: 8px; border:solid 1px #63da7e;z-index: 2;cursor: sw-resize;"></div>
				<div id="se" class="shape-controler " style="background:white; position: absolute;right: -5px;bottom: -5px; width: 8px;height: 8px; border:solid 1px #63da7e;z-index: 2;cursor: se-resize;"></div>
			</div>
		    <div class="shape-conn" style="position: absolute; right:-17px;top:83px;width:41px;height:41px;border:solid 1px #f1ad1f;border-radius:20px;background-color: #e8d6af;display: none;z-index: 3;line-height:14px;text-align: center;font-size:14px;cursor: crosshair;"><br>
		    	conn
		    </div>
		</div> -->
	</div>
</div>
<script>
     var first=new dot('236713',null,null,null,null,null);
 //   $('body').append(ConnectHTML);
 	// $('.retangle').draggable();
 	// $('.retangle').click(function(){
 	// 	$('#shape-control').css("display","block");
 	// 	return false;
 	// });
 	// $('.retangle').mouseenter(function(){
 	// 	$('.shape-conn').css("display","block");
 	// 	 $('.shape-conn').click(function(){
  //   			$('.shape-conn').css("background-color","white");
  //   			return false;
  //  		 });
 	// }).mouseleave(function(){
 	// 	$('.shape-conn').css("display","none");
 	// 	$('.shape-conn').css("background-color","#e8d6af");
 	// });
 	// $('#se').mousedown(function(event){
 	// 		var el=$(this);
 	// 		var disX=event.pageX-el.left;
 	// 		var disY=event.pageY-el.top;
 	// 		$(this).mousemove(function(ev) {
 	// 			var el=$(this);
		// 		console.log(ev.pageY-el.top+"       "+ev.pageX-el.left);
		// 	});
		// return false;

 	// });
 	// $('.right-show').bind('click', function() {  
  //               $('#shape-control').css("display","none");  
  //        });
    var isconnected = false;
    // var input = document.getElementById("input");
    // var echo = document.getElementById("echo");
     $('.connectButton').click(function(){
		    		$(this).val("Connecting...");
		    		$(this).animate({opacity:0.5},100);
		    		setTimeout(function(){
		    			mywebsockinit();
		    		},400);

		    });
    readyevent();
    var wsock;
    var left_btn_isclosed=false;
    function readyevent(){
		

		    $('.left-btn span').mouseenter(
		    	function(){
		    		var pos=$(this).css("background-position");
		    		var index=pos.indexOf(' ');
		            var pos_y=pos.substring(index,pos.length);
		    		$(this).css("background-position","-22px "+pos_y);
		    		// if(left_btn_isclosed)
		    		//     $(this).css("background-position","-22px -151x");
		    		// else
		    		// 	$(this).css("background-position","-22px 0px");
		    	})
		    $('.left-btn span').mouseleave(
		    	function(){
		    		var pos=$(this).css("background-position");
		    		var index=pos.indexOf(' ');
		            var pos_y=pos.substring(index,pos.length);
		    		$(this).css("background-position","0px "+pos_y);
		    	// 	if(left_btn_isclosed)
		    	// 		$(this).css("background-position","0px -151px");
		    	// 	else
		    	// 	    $(this).css("background-position","0px 0px");
				 }
			);
		    $('.left-btn span').click(function(){
		    	var width=$('.left-menu').css("width");
		    	var width=200-parseInt(width);
		    	$('.left-menu').css("width",width+"px");
		    	$('.left-btn').css("left",width+"px");
		    	if(left_btn_isclosed)
		    	{
                     $(this).css("background-position","0px 0px"); 
                     $('.right-show').css({"left":"215px","width":"1118px"});

		    	}
		    	else{
		    		 $(this).css("background-position","0px -151px"); 
		    		 $('.right-show').css({"left":"15px","width":"1318px"});
		    	}
		    	left_btn_isclosed=!left_btn_isclosed;
		    });
			


    };
  

    // var plainmsg = {"head":"","record":"","expand":""};
    // plainmsg["head"]={"tag":"MESG","version":65537};
    // var jsonstr = JSON.stringify(plainmsg);

    function mywebsockinit() {
        if (isconnected) {
            alert("已连接服务器！")
            return;
        }
        var netaddr=document.getElementById("addr");
        var netport=document.getElementById("port");

 //       wsock = new WebSocket('ws://192.168.159.135:12888', 'cube-wsport');
        wsock = new WebSocket('ws://'+netaddr.value+':'+netport.value, 'cube-wsport');

        wsock.onopen = function (e) {
            if (!isconnected) {
                isconnected = true;
    //             alert("连接成功！");
                $("body *:not('script')").each(function(){
				$(this).remove();
				});
               $('body').append(ShowHTML);
               readyevent();
            }
            return;
        };
        wsock.onclose = function (e) {
        };
        wsock.onerror = function (e) {
        	$('.connectButton').val("Connect");
        	$('.connectButton').animate({opacity:1},100);
        };
        wsock.onmessage = function (e) {
                var msg;
            msg = JSON.parse(e.data);
  //          if (msg.replace(/(^s*)|(s*$)/g, "").length != 0) {
   //             alert(msg);
   //         }
 //           for (var key in msg.RECORD) {
			 	   var graph = new Q.Graph('canvas');
			    	function createNodes(){
			    	var i;
			    	for( i=0;i<array.length;i++){
			    		var storge_element =new node();
			    		storge_element.init(i,array[i].name,array[i].uuid,array[i].parent,array[i].type);

			    		nodes_storge.push(storge_element);
			    		var show_element= graph.createNode(array[i].name);
			    		
			    		if(array[i].type=="plugin"){
			    			nodes_show[array[i].parent].enableSubNetwork=nodes_show[array[i].parent].enableSubNetwork||true;
			    			show_element.parent=nodes_show[array[i].parent];
			    		}
			    		nodes_show.push(show_element);
			    	}
			    	
			    }
			    function createEdges(){
			    	var i;
			    	for(i=0;i<jsonEdges.length;i++){
			    		var edge_show=graph.createEdge("",nodes_show[jsonEdges[i].from],nodes_show[jsonEdges[i].to]);
			    		if(nodes_storge[jsonEdges[i].from].gettype()=="plugin")
			    			edge_show.parent=nodes_show[nodes_storge[jsonEdges[i].from].getparent()];
			    	}

			    }
			    createNodes();
			    createEdges();
			    var layouter = new Q.TreeLayouter(graph);
				layouter.layoutType = Q.Consts.LAYOUT_TYPE_TWO_SIDE;
				layouter.doLayout({callback: function(){
			    graph.zoomToOverview();
				}});
                if (msg.RECORD[0].message != null) {
                	console.log(msg.RECORD[0].message);
                    document.getElementById("echo").value += msg.RECORD[0].message;
                    document.getElementById("echo").value += '\n';

                }
        }
    }

    function myFunction() {
        if(!isconnected)
        {
            alert("连接未建立！")
            return;
        }
        
        var message = {message:input.value};
        var msg = new Cube_msg("MESSAGE","BASE_MSG");
        msg.addrecord(message);
        wsock.send(msg.output())
    }
</script>
<body>
</html>