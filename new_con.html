<!DOCTYPE html>
<html>
<head>
	<title>ConnecttoServer</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./css/style.css">


    <script type="text/javascript" src="./js/exchange.js"></script>
    <script src="http://demo.qunee.com/lib/qunee-min.js"></script>
    <script type="text/javascript" src="./js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="./js/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/jquery-ui.min.css">
    <script type="text/javascript" src="./bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./bootstrap/css/bootstrap.min.css">
    <script src="./js/data_struct.js"></script>
    <script type="text/javascript" src="./js/message.js"></script>
	<script src="./js/data_source.js"></script>
</head>
<body>
<!-- <div class="modal fade" id="myModal" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
            <h4 class="modal-title" id="myModalLabel">
               补充Path的type和subtype
            </h4>
         </div>
         <div class="modal-body">
            <label class="">Type</label>
            <input class="type">
            <label class="">SubType</label>
            <input class="subtype">
         </div>
         <div class="modal-footer">
            <button type="button" class="save_type"
               data-dismiss="modal">保存
            </button>
         </div>
      </div>
</div>
</div>
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
            <h4 class="modal-title" id="myModalLabel">
               新建Path属性
            </h4>
         </div>
         <div class="modal-body">
            <div>
	            <label class="type_label">Type</label>
	            <input class="add_type">
            </div>
            <div>
	            <label class="subtype_label">SubType</label>
	            <input class="add_subtype">
	        </div>
	        <div>
	            <label class="color_label">Color</label>
	            <input class="add_colorpicker">
	        </div>
         </div>
         <div class="modal-footer">
            <button type="button" class="save_type"
               data-dismiss="modal">保存
            </button>
         </div>
      </div>
</div>
</div>
<div class="top-menu">
</div>
<div  id="canvas" class="show-canvas">
	<div class="save"></div>
</div>
<div class="mainbody">
	<div class="left-menu">
	<div class="title">MANAGER</div>
    <div class="plugin_list">
        <div class="plugin_img"></div>
        <div style="height:30px;width: 100px;float: left;padding-left:10px;text-align: center">PLUGIN</div>
    </div>
    <button class="send threedbutton orange">发送全图</button>
	</div>
	<div class="left-btn"><span></span>
	</div>
	<div  class="right-show" id="canvas"/>
	</div>
</div> -->
<script>
     $('body').append(ConnectHTML);
     var cur_manager;
     var kvmap;
     var graph;
     var model;
     var layoutr;
     var color_manager;
     var plugins;
     var drag;
     var save_btn;
function init_Global() {
     cur_manager=new cur_status();
     kvmap=[];
     graph=new Q.Graph('canvas');
     model= graph.graphModel;
     var cur_data=null;
     graph.onkeydown=function(evt){
        if(evt.keyCode==46&&cur_data){
            model.remove(cur_data);
            cur_data=null;
        }
     }
    model.selectionChangeDispatcher.addListener(function(evt){
        cur_data=evt.data;
        Q.log(evt.kind);
    });
     model.listChangeDispatcher.addListener(function(evt){
        if(graph.interactionMode=== Q.Consts.INTERACTION_MODE_CREATE_SIMPLE_EDGE&&evt.kind=="add"){
            if(cur_manager.get_curcolor()=="#000000"){
                alert("请选择一种颜色或者新建一条路径");
                model.remove(evt.data);
            }else{
            var Edge=evt.data;
                Edge.setStyle(Q.Styles.EDGE_COLOR,cur_manager.get_curcolor());
                console.log(Edge.from.name);
           }
        }
        Q.log(evt.kind);
     });
     layouter = new Q.TreeLayouter(graph);
     factory(topo,kvmap);
     init_toolbar();
     color_manager=new color_bar();
     plugins=new plugin_list();
     drag= new dragdiv();
     save_btn=new save_to_dot();
  

     $('#myModal1').on('hide.bs.modal', function () {
            if(!$('.add_type').val()||!$('.add_subtype').val()||!$('.add_colorpicker').val())
                    alert("保存失败");
             else{
                     color_manager.add_newcolor($('.add_colorpicker').val(),$('.add_type').val(),$('.add_subtype').val());
             }
                            
      });
      $('.send').on("click",function(){
        // if(!isconnected)
        // {
        //     alert("连接未建立！")
        //     return;
        // }   
        var new_topo=[];
        for(var i in kvmap){
            new_topo.push(kvmap[i].get_json())
        }
        var msg = new Cube_msg("MESSAGE","BASE_MSG");
        msg.addrecord(new_topo);
        wsock.send(msg.output())

      });

    $('.right-show').on('click',function(){
        $('.line-controler').css("display","none");
        $('.controler').css("display","none");
        model.clear();
    //  $('.clr_group').remove();
        color_manager.clearalltype();
        cur_manager.init();
        return false;
    });
    readyevent();
   
    // var input = document.getElementById("input");
    // var echo = document.getElementById("echo");
     
}
   $('.connectButton').click(function(){
                    $(this).val("Connecting...");
                    $(this).animate({opacity:0.5},100);
                    setTimeout(function(){
                        mywebsockinit();
                    },400);

            });
	var isconnected = false;
    var wsock;
    var left_btn_isclosed=false;
    function readyevent(){
		    $('.left-btn span').mouseenter(
		    	function(){
		    		var pos=$(this).css("background-position");
		    		var index=pos.indexOf(' ');
		            var pos_y=pos.substring(index,pos.length);
		    		$(this).css("background-position","-22px "+pos_y);
		    		// if(left_btn_isclosed)
		    		//     $(this).css("background-position","-22px -151x");
		    		// else
		    		// 	$(this).css("background-position","-22px 0px");
		    	})
		    $('.left-btn span').mouseleave(
		    	function(){
		    		var pos=$(this).css("background-position");
		    		var index=pos.indexOf(' ');
		            var pos_y=pos.substring(index,pos.length);
		    		$(this).css("background-position","0px "+pos_y);
		    	// 	if(left_btn_isclosed)
		    	// 		$(this).css("background-position","0px -151px");
		    	// 	else
		    	// 	    $(this).css("background-position","0px 0px");
				 }
			);
		    $('.left-btn span').click(function(){
		    	var width=$('.left-menu').css("width");
		    	var width=200-parseInt(width);
		    	$('.left-menu').css("width",width+"px");
		    	$('.left-btn').css("left",width+"px");
		    	if(left_btn_isclosed)//当前为打开，需要变为关闭
		    	{
                     $(this).css("background-position","0px 0px"); 
                     $('.right-show').css({"left":"215px","width":"1118px"});
                     $('.left-menu').css("display","block");

		    	}
		    	else{//当前为关闭，需要变为打开
		    		 $(this).css("background-position","0px -151px"); 
		    		 $('.right-show').css({"left":"15px","width":"1318px"});      
                     $('.left-menu').css("display","none");
		    	}
		    	left_btn_isclosed=!left_btn_isclosed;
		    });
			
    };
    // var plainmsg = {"head":"","record":"","expand":""};
    // plainmsg["head"]={"tag":"MESG","version":65537};
    // var jsonstr = JSON.stringify(plainmsg);

    function mywebsockinit() {
        if (isconnected) {
            alert("已连接服务器！")
            return;
        }
        var netaddr=document.getElementById("addr");
        var netport=document.getElementById("port");

 //       wsock = new WebSocket('ws://192.168.159.135:12888', 'cube-wsport');
        wsock = new WebSocket('ws://'+netaddr.value+':'+netport.value, 'cube-wsport');

        wsock.onopen = function (e) {
            if (!isconnected) {
                isconnected = true;
    //             alert("连接成功！");
                $("body *:not('script')").each(function(){
				$(this).remove();
				});
               $('body').append(ShowHTML);
               init_Global();
            }
            return;
        };
        wsock.onclose = function (e) {
        };
        wsock.onerror = function (e) {
        	$('.connectButton').val("Connect");
        	$('.connectButton').animate({opacity:1},100);
        };
        wsock.onmessage = function (e) {
                var msg;
            msg = JSON.parse(e.data);
        }
    }
</script>
<body>
</html>